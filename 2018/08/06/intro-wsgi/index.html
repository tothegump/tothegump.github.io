<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简单聊下 WSGI | Stupid is as stupid does</title>
    <meta name="description" content="
是pep 3333中定义的一个规范。其实是希望把底层网络处理跟应用分开，这也是因为这 Java 中有 servlet 的成功案例，可以看到这样分一层的巨大好处。有了 wsgi 之后，Python 语言的 Web 框架变得炒鸡多，随便就可以说上来很多：Django, Flask, web.py(sign), web2py, bottle, pylons, humph (偷偷摸摸放进来，话说这个好久 ...">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.47c10540.css" as="style"><link rel="preload" href="/assets/js/app.8713b285.js" as="script"><link rel="preload" href="/assets/js/29.8b77c28a.js" as="script"><link rel="preload" href="/assets/js/5.a890f757.js" as="script"><link rel="preload" href="/assets/js/18.4e38416b.js" as="script"><link rel="prefetch" href="/assets/js/13.f0b04c5b.js"><link rel="prefetch" href="/assets/js/1.b23a47f1.js"><link rel="prefetch" href="/assets/js/3.119ccb4a.js"><link rel="prefetch" href="/assets/js/4.9410402b.js"><link rel="prefetch" href="/assets/js/6.53327dae.js"><link rel="prefetch" href="/assets/js/7.4896b72f.js"><link rel="prefetch" href="/assets/js/8.a1a2dde7.js"><link rel="prefetch" href="/assets/js/9.221d2e76.js"><link rel="prefetch" href="/assets/js/10.0a051333.js"><link rel="prefetch" href="/assets/js/11.eef099e2.js"><link rel="prefetch" href="/assets/js/12.a89cf265.js"><link rel="prefetch" href="/assets/js/14.5b6ce92e.js"><link rel="prefetch" href="/assets/js/15.dc6f38fd.js"><link rel="prefetch" href="/assets/js/16.f56f9898.js"><link rel="prefetch" href="/assets/js/17.d3476957.js"><link rel="prefetch" href="/assets/js/19.75106691.js"><link rel="prefetch" href="/assets/js/20.b7e49cb9.js"><link rel="prefetch" href="/assets/js/21.18084f5d.js"><link rel="prefetch" href="/assets/js/22.01eeebe5.js"><link rel="prefetch" href="/assets/js/23.ef208987.js"><link rel="prefetch" href="/assets/js/24.41c931dd.js"><link rel="prefetch" href="/assets/js/25.127bdf1e.js"><link rel="prefetch" href="/assets/js/26.8b0c9afd.js"><link rel="prefetch" href="/assets/js/27.a524ea30.js"><link rel="prefetch" href="/assets/js/28.d27e5638.js"><link rel="prefetch" href="/assets/js/30.88c816c6.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.5397a2a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.47c10540.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Stupid is as stupid does </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">文章</a></li><li class="nav-item"><a href="/arts/" class="nav-link">ARTS</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Stupid is as stupid does </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">文章</a></li><li class="mobile-nav-item"><a href="/arts/" class="nav-link">ARTS</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        简单聊下 WSGI
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2018-08-06T09:41:19.000Z">
      2018-08-06
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/wsgi" data-v-d832e844> wsgi </a></li><li class="post-tag" data-v-d832e844><a href="/tag/python" data-v-d832e844> python </a></li><li class="post-tag" data-v-d832e844><a href="/tag/web-server" data-v-d832e844> web-server </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="wsgi-是个什么？"><a href="#wsgi-是个什么？" aria-hidden="true" class="header-anchor">#</a> WSGI 是个什么？</h2> <p>是pep 3333中定义的一个规范。其实是希望把底层网络处理跟应用分开，这也是因为这 Java 中有 servlet 的成功案例，可以看到这样分一层的巨大好处。有了 wsgi 之后，Python 语言的 Web 框架变得炒鸡多，随便就可以说上来很多：Django, Flask, web.py(sign), web2py, bottle, pylons, humph (偷偷摸摸放进来，话说这个好久不更新了，提出批评)。</p> <p>wsgi 主要分了两层， Application/Framework Side 和 Server/Gateway Side，如果有一些两边都沾边的组件，就叫 Middleware。</p> <blockquote><p>（题外话：因为Python 有众所周知的蛋疼的编码问题，这里也着重强调了字符的类型问题）</p></blockquote> <p>我们常见的Web Framework 处理的都是 Application Side，跟这这个描述，你也可以很轻松的写出自己的 Web 框架。</p> <p>在部署的时候，用的工具比如 uWSGI, gnunicon 都是 Server side的东西。其实在框架里面也实现了简单的server side，供调试用，没有考虑效率。</p> <h3 id="application-side"><a href="#application-side" aria-hidden="true" class="header-anchor">#</a> Application Side</h3> <p>只需要</p> <ol><li>定义一个 接收两个参数的 callable object</li> <li>可以多次调用</li></ol> <p>这样看起来很容易，确实是这样。如果想要用起来，就需要考虑更多细节问题。
比如，怎么路由啊， 怎么封装 request 和 response 啊，等等</p> <p>实际上，wsgi中对细节有很多定义，比如 environ variables, the star_response() callable, buffering and streaming, Unicode issues, error handling, http1.1, thread support.</p> <h2 id="一些细节"><a href="#一些细节" aria-hidden="true" class="header-anchor">#</a> 一些细节</h2> <ul><li>定义的 callable application object 接受两个参数，虽然这描述的时候称为 environ 和 start_response, 但这两个参数并非命名参数，必须通过位置来标识。</li> <li>参数 environ 必须是 Python 的 buildin 的字典类型，子类啊， UserDict 啊什么的都不行</li> <li>参数 start_response 是一个接受两个必选参数和一个可选参数的可调用类型。</li></ul> <h2 id="environ-variables"><a href="#environ-variables" aria-hidden="true" class="header-anchor">#</a> environ variables</h2> <h3 id="cgi-环境变量"><a href="#cgi-环境变量" aria-hidden="true" class="header-anchor">#</a> CGI 环境变量</h3> <p>环境变量这个 dict 必须包含 CGI 环境变量，一部分是必须出现的（除非值为空字符串），还有一部分是可忽略的。这些环境变量比较容易理解，分别是</p> <ul><li>Server 相关
<ul><li>SERVER_NAME, SERVER_PORT</li> <li>SERVER_PROTOCOL</li> <li>SCRIPT_NAME</li></ul></li> <li>请求相关
<ul><li>REQUEST_METHOD</li> <li>PATH_INFO</li> <li>QUERY_STRING</li> <li>CONTENT_TYPE</li> <li>CONTENT_LENGTH</li></ul></li> <li>其他的请求头变量
<ul><li>HTTP_<em>Variables</em> : 比如说，HEADER 中的 Authorization 字段，这里就是 HTTP_AUTHORIZATION 变量</li></ul></li></ul> <h3 id="wsgi-变量"><a href="#wsgi-变量" aria-hidden="true" class="header-anchor">#</a> WSGI 变量</h3> <p>除了上面的 CGI 变量， environ 字典可能包含任意的操作系统环境变量，必须包含这些 WSGI 变量：</p> <ul><li>wsgi.version</li> <li>wsgi.url_scheme  是 http 还是 https</li> <li>wsgi.input  一般请求的 body 中的数据是以类似读取文件的方式获取。</li> <li>wsgi.error</li> <li>wsgi.multithread</li> <li>wsgi.multiprocess</li> <li>wsgi.run_once</li></ul> <h2 id="start-response"><a href="#start-response" aria-hidden="true" class="header-anchor">#</a> start_response()</h2> <p>这个函数接受两个必选一个可选参数，可以理解为 <code>start_response(status, response_headers, exc_info=None)</code>，当然，是按照位置区分，不接受命名参数。返回一个 <code>write(body_data)</code>的可调用对象。</p> <h2 id="buffering-and-streaming"><a href="#buffering-and-streaming" aria-hidden="true" class="header-anchor">#</a> Buffering and Streaming</h2> <p>这里要说到两种情况，一种是 response 的内容刚刚好，pia 的一下，一次就给返回去了，一种是， 要么很大，要么很耗时，只能给一坨一坨地返回。</p> <h2 id="未完待续"><a href="#未完待续" aria-hidden="true" class="header-anchor">#</a> 未完待续</h2> <p>嗯。</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#wsgi-是个什么？" title="WSGI 是个什么？">WSGI 是个什么？</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#application-side" title="Application Side">Application Side</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#一些细节" title="一些细节">一些细节</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#environ-variables" title="environ variables">environ variables</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#cgi-环境变量" title="CGI 环境变量">CGI 环境变量</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#wsgi-变量" title="WSGI 变量">WSGI 变量</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#start-response" title="start_response()">start_response()</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#buffering-and-streaming" title="Buffering and Streaming">Buffering and Streaming</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#未完待续" title="未完待续">未完待续</a></div></div></div></div> <footer class="footer" data-v-582f9766><div class="footer-left-wrap" data-v-582f9766><ul class="contact" data-v-582f9766><li class="contact-item" data-v-582f9766><a href="https://github.com/tothegump" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-582f9766><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-582f9766><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-582f9766></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-582f9766><ul class="copyright" data-v-582f9766></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8713b285.js" defer></script><script src="/assets/js/29.8b77c28a.js" defer></script><script src="/assets/js/5.a890f757.js" defer></script><script src="/assets/js/18.4e38416b.js" defer></script>
  </body>
</html>
